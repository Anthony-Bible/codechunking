# Base configuration for CodeChunking
# See wiki/configuration-reference.md for complete documentation

api:
  host: 0.0.0.0               # API server bind address
  port: 8080                  # API server port
  read_timeout: 10s           # Maximum duration for reading HTTP requests
  write_timeout: 10s          # Maximum duration for writing HTTP responses
  # Middleware flags (optional, default to true)
  # enable_default_middleware: true
  # enable_cors: true
  # enable_security_headers: true
  # enable_logging: true
  # enable_error_handling: true

worker:
  concurrency: 5              # Number of concurrent worker processes (min: 1)
  queue_group: workers        # NATS queue group name for load balancing
  job_timeout: 30m            # Overall timeout for complete job processing
                             # Must be larger than (gemini.timeout Ã— max_chunks_per_repo)
                             # to allow all embeddings to complete

database:
  host: localhost              # Database server hostname
  port: 5432                   # Database port (1-65535)
  name: codechunking           # Database name (required)
  # user:                      # Database username (required, set via env var)
  # password:                  # Database password (required, set via env var)
  sslmode: disable             # SSL mode: "disable", "require", "prefer"
  max_connections: 25          # Maximum open connections
  max_idle_connections: 5      # Maximum idle connections

nats:
  url: nats://localhost:4222   # NATS server URL
  max_reconnects: 5            # Maximum reconnection attempts
  reconnect_wait: 2s           # Time between reconnection attempts
  # test_mode: false          # Enable test mode for debugging

search:
  iterative_scan_mode: relaxed_order  # pgvector 0.8.0+ iterative scanning mode
                                       # Options: "off", "strict_order", "relaxed_order"
                                       # relaxed_order recommended for best recall/performance

gemini:
  model: gemini-embedding-001
  max_retries: 3
  timeout: 120s  # Per-request timeout for embedding generation
                 # Applied to each individual embedding API call
                 # Should be less than worker job_timeout
  batch:
    enabled: true
    input_dir: /tmp/batch_embeddings/input
    output_dir: /tmp/batch_embeddings/output
    poll_interval: 5s
    max_wait_time: 30m

# Batch processing configuration for enhanced embedding generation
batch_processing:
  # Enable queue-based batch processing alongside individual processing
  enabled: true
  # Threshold for switching to batch processing (chunks > this value use batch)
  threshold_chunks: 50
  # Batch size configuration by priority level
  batch_sizes:
    # Real-time priority: 1-25 requests (lowest latency)
    realtime:
      min: 1
      max: 25
      timeout: 5m
    # Interactive priority: 5-50 requests (responsive UI)
    interactive:
      min: 5
      max: 50
      timeout: 10m
    # Background priority: 50-200 requests (balanced for job processing)
    background:
      min: 50
      max: 200
      timeout: 30m
    # Batch priority: 100-500 requests (maximum efficiency)
    batch:
      min: 100
      max: 500
      timeout: 60m
  # Fallback configuration
  fallback_to_sequential: true  # Fall back to individual processing on batch failures
  queue_limits:
    max_queue_size: 10000       # Maximum requests in queue
    max_wait_time: 30m          # Maximum time waiting in queue
  # Default priority for job processing
  default_priority: "background"
  # Test embeddings configuration (for development/testing only)
  use_test_embeddings: false
  # Batch chunking strategy parameters
  max_batch_size: 500           # Maximum chunks per API batch
  initial_backoff: 30s          # Initial backoff delay for retries
  max_backoff: 300s             # Maximum backoff delay
  max_retries: 3                # Maximum retry attempts per batch
  enable_batch_chunking: true   # Enable/disable batch chunking

  # Batch Submitter configuration (rate-limit-aware submission)
  submitter_poll_interval: 5s         # How often to check for pending submissions
  max_concurrent_submissions: 1       # Max parallel Gemini API submissions (1 = safest)
  submission_initial_backoff: 1m      # Initial backoff on rate limit
  submission_max_backoff: 30m         # Maximum backoff duration
  max_submission_attempts: 10         # Max retry attempts per batch submission

  # Token counting configuration
  token_counting:
    enabled: true                    # Enable token counting
    mode: "all"                      # Mode: "all", "sample", or "on_demand"
    sample_percent: 10               # Percentage of chunks to sample (for "sample" mode)
    max_tokens_per_chunk: 8192       # Maximum tokens per chunk (Gemini embedding model limit)

log:
  level: info                   # Log level: "debug", "info", "warn", "error"
  format: json                  # Log format: "json", "text"

# Git operations configuration
git:
  default_depth: 1              # Git clone depth (0 = full, 1 = shallow)
  shallow_clone_threshold_mb: 100  # Repository size threshold for shallow clone
  default_timeout: 30m          # Default git operation timeout
  max_concurrent_clones: 3      # Maximum concurrent git clone operations
  retry_attempts: 2             # Retry attempts for git operations
  retry_backoff_duration: 5s    # Backoff between git retries
  enable_progress_tracking: true    # Enable git operation progress tracking
  enable_performance_monitoring: true  # Enable git performance monitoring
  auto_select_strategy: true    # Automatically select clone strategy
  workspace_cleanup_enabled: true      # Enable workspace cleanup
  workspace_cleanup_interval: 24h      # Cleanup interval

# Security configuration
security:
  max_url_length: 2048          # Maximum URL length (characters)
  max_body_size: 65536          # Maximum request body size (64KB)
  enable_xss_protection: true   # Enable XSS protection
  enable_sql_injection: true    # Enable SQL injection protection
  enable_control_char_check: true   # Enable control character validation
  enable_unicode_check: true    # Enable Unicode validation
  enable_path_traversal: true   # Enable path traversal protection
  log_security_violations: true # Log security violations
  log_level: "INFO"             # Security log level
  enable_validation_cache: true # Enable validation caching
  cache_size: 1000              # Validation cache size
  cache_ttl: 5m                 # Validation cache TTL
  rate_limit:
    requests_per_minute: 60     # Rate limit per minute
    burst_size: 10              # Burst capacity
    window_size: 1m             # Rate limit window
    enabled: true               # Enable rate limiting
